package dbms; // 1. ä¿®æ­£ï¼šåŒ…åæ”¹ç‚º dbms

// å¯¼å…¥
import org.postgresql.copy.CopyManager;
import org.postgresql.core.BaseConnection;

import java.io.FileReader;
import java.io.IOException;
import java.io.Reader;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.concurrent.TimeUnit;

/**
 * æ•°æ®åº“å¯¼å…¥å™¨ (V2 - é«˜é€Ÿ COPY ç‰ˆ)
 * [å·²é€‚é…æ‚¨çš„é¡¹ç›®ç»“æ„]
 * - ä½äº 'dbms' åŒ…
 * - ç§»é™¤äº†ç¡¬ç¼–ç çš„å¯†ç 
 * - é‡å¤ä½¿ç”¨ 'PostgreSQLConnector.java' æ¥è·å–æ•°æ®åº“è¿æ¥
 */
public class CSVImporter { // 2. ä¿®æ­£ï¼šç±»åç®€åŒ–

    // 3. ä¿®æ­£ï¼šç§»é™¤äº†ç¡¬ç¼–ç çš„ DB_URL, DB_USER, DB_PASSWORD
    //    å› ä¸ºæˆ‘ä»¬å°†ä½¿ç”¨ PostgreSQLConnector

    // æ–‡ä»¶è·¯å¾„é…ç½® (è¿™éƒ¨åˆ†ä¿æŒä¸å˜ï¼Œè¯·ç¡®ä¿è·¯å¾„ D:/... æ­£ç¡®)
    private static final String FILE_PATH_PREFIX ="C:\\æ•°æ®åº“åŸç†\\decomposer\\";
    private static final String RECIPES_FILE = FILE_PATH_PREFIX + "Recipe.csv";
    private static final String REVIEWS_FILE = FILE_PATH_PREFIX + "Review.csv";
    private static final String USERS_FILE = FILE_PATH_PREFIX + "User.csv";
    private static final String CATEGORIES_FILE = FILE_PATH_PREFIX + "Category.csv";
    private static final String KEYWORDS_FILE = FILE_PATH_PREFIX + "Keyword.csv";
    private static final String INGREDIENTS_FILE = FILE_PATH_PREFIX + "Ingredient.csv";
    private static final String NUTRITION_FILE = FILE_PATH_PREFIX + "Nutrition.csv";
    private static final String RECIPE_CATEGORIES_FILE = FILE_PATH_PREFIX + "Recipe_Category.csv";
    private static final String RECIPE_KEYWORDS_FILE = FILE_PATH_PREFIX + "Recipe_Keyword.csv";
    private static final String RECIPE_INGREDIENTS_FILE = FILE_PATH_PREFIX + "Recipe_Ingredient.csv";
    private static final String USER_FAVORITES_FILE = FILE_PATH_PREFIX + "User_Favorite_Recipe.csv";
    private static final String USER_FOLLOWS_FILE = FILE_PATH_PREFIX + "User_Follow.csv";
    private static final String REVIEW_LIKES_FILE = FILE_PATH_PREFIX + "User_Like_Review.csv";


    public static void main(String[] args) {
        CSVImporter importer = new CSVImporter(); // ä¿®æ­£ï¼šä½¿ç”¨æ–°ç±»å
        importer.runImport();
    }

    @FunctionalInterface
    interface ImportTask {
        void run(Connection conn) throws IOException, SQLException;
    }

    private void runSingleImport(Connection conn, String taskName, ImportTask task) {
        try {
            System.out.println("\n-----------------------------------------");
            System.out.println("å¼€å§‹å¯¼å…¥ " + taskName + "...");
            long taskStartTime = System.currentTimeMillis();

            task.run(conn);

            long taskEndTime = System.currentTimeMillis();
            double taskDuration = (taskEndTime - taskStartTime) / 1000.0;
            System.out.printf("... %s å¯¼å…¥ä»»åŠ¡ç»“æŸã€‚è€—æ—¶: %.2f ç§’ã€‚\n", taskName, taskDuration);

        } catch (Exception e) {
            System.err.println("\n[!! ä¸¥é‡é”™è¯¯ !!] å¯¼å…¥ " + taskName + " æ—¶å¤±è´¥: " + e.getMessage());
            System.err.println("  > [!! æç¤º !!] COPY å¤±è´¥é€šå¸¸æ„å‘³ç€ CSV æ•°æ®ç±»å‹ä¸æ•°æ®åº“è¡¨ä¸åŒ¹é…ï¼Œ");
            System.err.println("  >        æˆ–è€… CSV åˆ—çš„é¡ºåºä¸ COPY è¯­å¥ä¸­æŒ‡å®šçš„é¡ºåºä¸ç¬¦ã€‚");
            e.printStackTrace();
        }
    }

    public void runImport() {
        long totalStartTime = System.currentTimeMillis();
        System.out.println("å¯¼å…¥ç¨‹åºå·²å¯åŠ¨ (V2 - COPY æ¨¡å¼)...");

        // 4. ä¿®æ­£ï¼šç§»é™¤äº† Class.forNameï¼Œå› ä¸º Maven ä¾èµ–å’Œ Connector ä¼šå¤„ç†

        // 5. ä¿®æ­£ï¼šä½¿ç”¨ PostgreSQLConnector.getConnection()
        try (Connection conn = PostgreSQLConnector.getConnection()) {

            conn.setAutoCommit(true);
            System.out.println("æ•°æ®åº“è¿æ¥æˆåŠŸã€‚");

            // æŒ‰é¡ºåºæ‰§è¡Œå¯¼å…¥
            runSingleImport(conn, "Users", this::importUsers);
            runSingleImport(conn, "Categories", this::importCategories);
            runSingleImport(conn, "Keywords", this::importKeywords);
            runSingleImport(conn, "Ingredients", this::importIngredients);
            runSingleImport(conn, "Recipes", this::importRecipes);
            runSingleImport(conn, "Reviews", this::importReviews);
            runSingleImport(conn, "Nutrition", this::importNutrition);
            runSingleImport(conn, "RecipeCategories", this::importRecipeCategories);
            runSingleImport(conn, "RecipeKeywords", this::importRecipeKeywords);
            runSingleImport(conn, "RecipeIngredients", this::importRecipeIngredients);
            runSingleImport(conn, "UserFavorites", this::importUserFavorites);
            runSingleImport(conn, "UserFollows", this::importUserFollows);
            runSingleImport(conn, "ReviewLikes", this::importReviewLikes);

            System.out.println("\n-----------------------------------------");
            System.out.println("ğŸ‰ æ‰€æœ‰ 13 ä¸ªå¯¼å…¥ä»»åŠ¡å·²å°è¯•æ‰§è¡Œã€‚");

        } catch (SQLException e) {
            System.err.println("æ•°æ®åº“è¿æ¥å¤±è´¥ï¼(æ£€æŸ¥ PostgreSQLConnector æˆ–æ•°æ®åº“æœåŠ¡æ˜¯å¦è¿è¡Œ)");
            e.printStackTrace();
        } catch (RuntimeException e) {
            // æ•è·æ¥è‡ª PostgreSQLConnector çš„è¿æ¥å¤±è´¥
            System.err.println(e.getMessage());
            e.printStackTrace();
        }

        // ... æ€»æ—¶é—´è®¡ç®— (ä¿æŒä¸å˜) ...
        long totalEndTime = System.currentTimeMillis();
        long totalDurationMs = totalEndTime - totalStartTime;
        long minutes = TimeUnit.MILLISECONDS.toMinutes(totalDurationMs);
        long seconds = TimeUnit.MILLISECONDS.toSeconds(totalDurationMs) % 60;
        long millis = totalDurationMs % 1000;

        System.out.println("\n=========================================");
        System.out.printf("   [!! INFO !!] å¯¼å…¥ç¨‹åºæ‰§è¡Œå®Œæ¯•ã€‚\n");
        System.out.printf("   [!! INFO !!] æ€»è€—æ—¶: %d åˆ† %d.%03d ç§’ (æ€»å…±: %d æ¯«ç§’)\n",
                minutes, seconds, millis, totalDurationMs);
        System.out.println("=========================================");
    }

    // -----------------------------------------------------------------
    //  é€šç”¨ COPY å¯¼å…¥å™¨
    // -----------------------------------------------------------------

    private void importWithCopy(Connection conn, String filePath, String copySql)
            throws SQLException, IOException {

        // [!! ä¿ç•™ !!] ä½¿ç”¨ .getCopyAPI()
        CopyManager copyManager = ((BaseConnection) conn).getCopyAPI();

        try (Reader reader = new FileReader(filePath)) {
            long rowsAffected = copyManager.copyIn(copySql, reader);
            System.out.println("  > [COPY] æˆåŠŸå¯¼å…¥ " + rowsAffected + " æ¡è®°å½•ã€‚");
        }
    }

    private static final String COPY_OPTIONS = "FROM STDIN WITH (FORMAT csv, HEADER true, NULL '', DELIMITER ',')";


    // -----------------------------------------------------------------
    //  [!! è­¦å‘Š !!] å¯¼å…¥æ–¹æ³• (SQL ä¸æ•°æ®åº“å¤§å°å†™)
    // -----------------------------------------------------------------

    // è­¦å‘Šï¼šæ‚¨é˜Ÿå‹çš„ COPY è¯­å¥ (å¦‚ COPY Users (UserID...)) ä½¿ç”¨çš„æ˜¯æ··åˆå¤§å°å†™ã€‚
    // è¿™è¦æ±‚æ‚¨çš„æ•°æ®åº“è¡¨å’Œåˆ—ååœ¨åˆ›å»ºæ—¶ä½¿ç”¨äº†åŒå¼•å· (ä¾‹å¦‚ CREATE TABLE "Users" ("UserID" INT...))ã€‚
    // è¿™ä¸æˆ‘ä»¬ä¸º PerformanceTester ä¿®æ­£çš„å…¨å°å†™ (users, userid) æ–¹æ¡ˆæ˜¯å†²çªçš„ã€‚
    // æ‚¨å¿…é¡»ç¡®ä¿æ‚¨çš„æ•°æ®åº“æ¨¡å¼ä¸ä»¥ä¸‹ COPY è¯­å¥åŒ¹é…ï¼

    // 1. Users
    private void importUsers(Connection conn) throws IOException, SQLException {
        String sql = "COPY Users (UserID, UserName, Gender, Age, Followers, Following) " + COPY_OPTIONS;
        importWithCopy(conn, USERS_FILE, sql);
    }

    // 2. Categories
    private void importCategories(Connection conn) throws IOException, SQLException {
        String sql = "COPY Categories (CategoryID, CategoryName) " + COPY_OPTIONS;
        importWithCopy(conn, CATEGORIES_FILE, sql);
    }

    // 3. Keywords
    private void importKeywords(Connection conn) throws IOException, SQLException {
        String sql = "COPY Keywords (KeywordID, KeywordName) " + COPY_OPTIONS;
        importWithCopy(conn, KEYWORDS_FILE, sql);
    }

    // 4. Ingredients
    private void importIngredients(Connection conn) throws IOException, SQLException {
        String sql = "COPY Ingredients (IngredientID, IngredientName) " + COPY_OPTIONS;
        importWithCopy(conn, INGREDIENTS_FILE, sql);
    }

    // 5. Recipes
    private void importRecipes(Connection conn) throws IOException, SQLException {
        String sql = "COPY Recipes (RecipeID, AuthorUserID, Name, CookingTime, PreparationTime, TotalTime, DatePublished, Description, AggregateRating, ReviewCount, RecipeServings, RecipeYield, RecipeInstructions) " + COPY_OPTIONS;
        importWithCopy(conn, RECIPES_FILE, sql);
    }

    // 6. Reviews
    private void importReviews(Connection conn) throws IOException, SQLException {
        String sql = "COPY Reviews (ReviewID, RecipeID, UserID, Rating, ReviewText, DateSubmitted, DateModified, Likes) " + COPY_OPTIONS;
        importWithCopy(conn, REVIEWS_FILE, sql);
    }

    // 7. Nutrition
    private void importNutrition(Connection conn) throws IOException, SQLException {
        String sql = "COPY Nutrition (RecipeID, Calories, FatContent, SaturatedFatContent, CholesterolContent, SodiumContent, CarbohydrateContent, FiberContent, SugarContent, ProteinContent) " + COPY_OPTIONS;
        importWithCopy(conn, NUTRITION_FILE, sql);
    }

    // 8. RecipeCategories
    private void importRecipeCategories(Connection conn) throws IOException, SQLException {
        String sql = "COPY RecipeCategories (RecipeID, CategoryID) " + COPY_OPTIONS;
        importWithCopy(conn, RECIPE_CATEGORIES_FILE, sql);
    }

    // 9. RecipeKeywords
    private void importRecipeKeywords(Connection conn) throws IOException, SQLException {
        String sql = "COPY RecipeKeywords (RecipeID, KeywordID) " + COPY_OPTIONS;
        importWithCopy(conn, RECIPE_KEYWORDS_FILE, sql);
    }

    // 10. RecipeIngredients
    private void importRecipeIngredients(Connection conn) throws IOException, SQLException {
        String sql = "COPY RecipeIngredients (RecipeID, IngredientID, Quantity) " + COPY_OPTIONS;
        importWithCopy(conn, RECIPE_INGREDIENTS_FILE, sql);
    }

    // 11. UserFavorites
    private void importUserFavorites(Connection conn) throws IOException, SQLException {
        String sql = "COPY UserFavorites (UserID, RecipeID) " + COPY_OPTIONS;
        importWithCopy(conn, USER_FAVORITES_FILE, sql);
    }

    // 12. UserFollows
    private void importUserFollows(Connection conn) throws IOException, SQLException {
        String sql = "COPY UserFollows (FollowerUserID, FollowingUserID) " + COPY_OPTIONS;
        importWithCopy(conn, USER_FOLLOWS_FILE, sql);
    }

    // 13. ReviewLikes
    private void importReviewLikes(Connection conn) throws IOException, SQLException {
        String sql = "COPY ReviewLikes (UserID, ReviewID) " + COPY_OPTIONS;
        importWithCopy(conn, REVIEW_LIKES_FILE, sql);
    }
}
